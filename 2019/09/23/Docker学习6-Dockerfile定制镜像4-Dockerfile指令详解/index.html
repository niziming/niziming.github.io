<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <link rel="icon" href="/img/favicon.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <!--<script async defer src="https://buttons.github.io/buttons.js"></script>-->
    <title>
        🔥
        
          Docker学习6-Dockerfile定制镜像4-Dockerfile指令详解 - 十渊 | Blog
        
    </title>

    <link rel="canonical" href="https://niziming.github.io/2019/09/23/Docker学习6-Dockerfile定制镜像4-Dockerfile指令详解/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/beantech.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    
<link rel="stylesheet" href="/css/widget.css">


    
<link rel="stylesheet" href="/css/rocket.css">


    
<link rel="stylesheet" href="/css/signature.css">


    
<link rel="stylesheet" href="/css/toc.css">


    
<link rel="stylesheet" href="/css/font-awesome.min.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <!--<link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">-->


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <!--<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>-->
    <!--<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>-->
    <!--[endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 7.3.0"></head>
<!-- buttons JavaScript -->

<script src="/js/buttons.js"></script>


<script src="/js/html5shiv.js"></script>


<script src="/js/respond.min.js"></script>



<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
    
        background-image: url('/img/article_header/article_bg.jpg')
        /*post*/
    
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                            
                              <a class="tag" href="/tags/#Dockerfile" title="Dockerfile">Dockerfile</a>
                            
                        </div>
                        <h1>Docker学习6-Dockerfile定制镜像4-Dockerfile指令详解</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 十渊 on
                            2019-09-23
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">十渊</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1><span id="dockerfile指令详解">Dockerfile指令详解</span></h1>
<p>我们已经介绍了 FROM，RUN，还提及了 COPY, ADD，其实 Dockerfile 功能很强大，它提供了十多个指令。下面我们继续讲解其他的指令。</p>
<h2><span id="练习过程">练习过程</span></h2>
<p>将index.html打包成project.tar,使用dockerfile将project.tar部署到镜像,解压project.tar,并删除project.tar后,开启容器访问</p>
<h3><span id="使用dockerfile将压缩包导入镜像">使用Dockerfile将压缩包导入镜像</span></h3>
<ol>
<li>准备压缩包里面的html</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Docker<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>我是压缩后的文件<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>编写dockerfile脚本</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile脚本开始</span></span><br><span class="line"><span class="keyword">FROM</span> tomcat</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local/tomcat/webapps/ROOT/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -fr *</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> project .</span></span><br></pre></td></tr></table></figure>
<ol start="3">
<li>测试Dockerfile脚本</li>
</ol>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/usr/</span>local/docker</span><br><span class="line">[root@MyCentOS]<span class="regexp">/usr/</span>local/docker# ls</span><br><span class="line">tomcat</span><br><span class="line">[root@MyCentOS]<span class="regexp">/usr/</span>local/docker# cd tomcat</span><br><span class="line">[root@MyCentOS]<span class="regexp">/usr/</span>local<span class="regexp">/docker/</span>tomcat# ls</span><br><span class="line">Dockerfile  index.html  <span class="keyword">project</span>.tar</span><br><span class="line">[root@MyCentOS]<span class="regexp">/usr/</span>local<span class="regexp">/docker/</span>tomcat# docker build -t myproject .</span><br><span class="line">Sending build context to Docker daemon  <span class="number">13.82</span>kB</span><br><span class="line"><span class="keyword">Step</span> <span class="number">1</span>/<span class="number">4</span> : <span class="keyword">FROM</span> tomcat</span><br><span class="line"> ---&gt; <span class="number">96</span>c4e536d0eb</span><br><span class="line"><span class="keyword">Step</span> <span class="number">2</span><span class="regexp">/4 : WORKDIR /u</span>sr<span class="regexp">/local/</span>tomcat<span class="regexp">/webapps/</span>ROOT/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; <span class="number">9350</span>deb03d0d</span><br><span class="line"><span class="keyword">Step</span> <span class="number">3</span>/<span class="number">4</span> : RUN rm -fr *</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; f6814fab3fe4</span><br><span class="line"><span class="keyword">Step</span> <span class="number">4</span>/<span class="number">4</span> : <span class="keyword">COPY</span> <span class="keyword">project</span> .</span><br><span class="line"><span class="keyword">COPY</span> failed: stat <span class="regexp">/var/</span>lib<span class="regexp">/docker/</span>tmp<span class="regexp">/docker-builder757135529/</span><span class="keyword">project</span>: no such <span class="keyword">file</span> or directory</span><br></pre></td></tr></table></figure>
<p>报错的原因查看到时project没有写正确应该是project.tar</p>
<ol start="4">
<li>查看镜像里面的详情</li>
</ol>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker run -it mydocker bash</span></span><br><span class="line">root<span class="variable">@7590d3a9542a</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line">root<span class="variable">@7590d3a9542a</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>index.html也没有在原本的路径下删除.</p>
<ol start="5">
<li>重新修改Dockerfile文件.</li>
</ol>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@MyCentOS]</span>/usr/<span class="keyword">local</span>/docker/tomcat<span class="meta"># ls</span></span><br><span class="line">Dockerfile  index.html  project.tar</span><br><span class="line">[root<span class="symbol">@MyCentOS]</span>/usr/<span class="keyword">local</span>/docker/tomcat<span class="meta"># rm index.html</span></span><br><span class="line">[root<span class="symbol">@MyCentOS]</span>/usr/<span class="keyword">local</span>/docker/tomcat<span class="meta"># ls</span></span><br><span class="line">Dockerfile  project.tar</span><br><span class="line">[root<span class="symbol">@MyCentOS]</span>/usr/<span class="keyword">local</span>/docker/tomcat<span class="meta"># vim Dockerfile</span></span><br><span class="line">[root<span class="symbol">@MyCentOS]</span>/usr/<span class="keyword">local</span>/docker/tomcat<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<ol start="6">
<li>再次执行<code>build</code>指令</li>
</ol>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker build -t myproject .</span></span><br><span class="line"><span class="title class_">Sending</span> build context to <span class="title class_">Docker</span> daemon   <span class="number">12.8</span>kB</span><br><span class="line"><span class="title class_">Step</span> <span class="number">1</span>/<span class="number">4</span> : <span class="title class_">FROM</span> tomcat</span><br><span class="line"> ---&gt; <span class="number">96</span>c4e536d0eb</span><br><span class="line"><span class="title class_">Step</span> <span class="number">2</span>/<span class="number">4</span> : <span class="title class_">WORKDIR</span> /usr/local/tomcat/webapps/<span class="title class_">ROOT</span>/</span><br><span class="line"> ---&gt; <span class="title class_">Using</span> cache</span><br><span class="line"> ---&gt; <span class="number">9350</span>deb03d0d</span><br><span class="line"><span class="title class_">Step</span> <span class="number">3</span>/<span class="number">4</span> : <span class="title class_">RUN</span> rm -fr *</span><br><span class="line"> ---&gt; <span class="title class_">Using</span> cache</span><br><span class="line"> ---&gt; f6814fab3fe4</span><br><span class="line"><span class="title class_">Step</span> <span class="number">4</span>/<span class="number">4</span> : <span class="title class_">COPY</span> project.tar .</span><br><span class="line"> ---&gt; <span class="number">3</span>be1d6707ad0</span><br><span class="line"><span class="title class_">Successfully</span> built <span class="number">3</span>be1d6707ad0</span><br><span class="line"><span class="title class_">Successfully</span> tagged <span class="symbol">myproject:</span>latest</span><br><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker run -it myproject bash</span></span><br><span class="line">root<span class="variable">@3ea53b2ca71a</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># ls</span></span><br><span class="line">project.tar</span><br><span class="line">root<span class="variable">@3ea53b2ca71a</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>构建镜像成功,并且交互查看镜像路径下的tar文件存在.</p>
<h3><span id="使用dockerfile指令解压打包的tar包并且删除tar包">使用Dockerfile指令,解压打包的tar包并且删除tar包</span></h3>
<ol>
<li>Dockerfile脚本</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Dockerfile脚本开始</span></span><br><span class="line"><span class="keyword">FROM</span> tomcat</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local/tomcat/webapps/ROOT/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> -fr *</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> project.tar .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> tar -xf project.tar</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">rm</span> project.tar</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>执行<code>build</code>构建镜像</li>
</ol>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@MyCentOS]/usr/local/docker/tomcat# docker build -t myproject .</span><br><span class="line">Sending build context to Docker daemon   <span class="number">12.8</span>kB</span><br><span class="line">Step <span class="number">1</span>/<span class="number">6</span> : <span class="type">FROM</span> tomcat</span><br><span class="line"> <span class="comment">---&gt; 96c4e536d0eb</span></span><br><span class="line">Step <span class="number">2</span>/<span class="number">6</span> : <span class="type">WORKDIR</span> /usr/local/tomcat/webapps/ROOT/</span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; 9350deb03d0d</span></span><br><span class="line">Step <span class="number">3</span>/<span class="number">6</span> : <span class="type">RUN</span> rm -fr *</span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; f6814fab3fe4</span></span><br><span class="line">Step <span class="number">4</span>/<span class="number">6</span> : <span class="type">COPY</span> project.tar .</span><br><span class="line"> <span class="comment">---&gt; Using cache</span></span><br><span class="line"> <span class="comment">---&gt; 3be1d6707ad0</span></span><br><span class="line">Step <span class="number">5</span>/<span class="number">6</span> : <span class="type">RUN</span> tar -xf project.tar</span><br><span class="line"> <span class="comment">---&gt; Running in 89050282e006</span></span><br><span class="line">Removing intermediate container <span class="number">89050282e006</span></span><br><span class="line"> <span class="comment">---&gt; e1ca7ee2959d</span></span><br><span class="line">Step <span class="number">6</span>/<span class="number">6</span> : <span class="type">RUN</span> rm project.tar</span><br><span class="line"> <span class="comment">---&gt; Running in 6124469472a5</span></span><br><span class="line">Removing intermediate container <span class="number">6124469472</span>a5</span><br><span class="line"> <span class="comment">---&gt; 1bb09f348be0</span></span><br><span class="line">Successfully built <span class="number">1</span>bb09f348be0</span><br><span class="line">Successfully <span class="keyword">tagged</span> myproject:latest</span><br><span class="line">[root@MyCentOS]/usr/local/docker/tomcat#</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>查看镜像里面的文件</li>
</ol>
<p>交互命令</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker run -it --rm myproject bash</span></span><br><span class="line">root<span class="variable">@c7c2d4feff2c</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line">root<span class="variable">@c7c2d4feff2c</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>启动镜像容器</li>
</ol>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo</span> docker run -p <span class="number">8081</span>:<span class="number">8080</span> myproject</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>查看结果<br>
<img src="/2019/09/23/Docker%E5%AD%A6%E4%B9%A06-Dockerfile%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F4-Dockerfile%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/1.png" alt><br>
字符编码未设置所有乱码.<br>
修改html</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>Docker文件测试<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello Docker<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>我是压缩后的文件<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>交互方式进入容器查看</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker build -t myproject .</span></span><br><span class="line"><span class="title class_">Sending</span> build context to <span class="title class_">Docker</span> daemon   <span class="number">12.8</span>kB</span><br><span class="line"><span class="title class_">Step</span> <span class="number">1</span>/<span class="number">6</span> : <span class="title class_">FROM</span> tomcat</span><br><span class="line"> ---&gt; <span class="number">96</span>c4e536d0eb</span><br><span class="line"><span class="title class_">Step</span> <span class="number">2</span>/<span class="number">6</span> : <span class="title class_">WORKDIR</span> /usr/local/tomcat/webapps/<span class="title class_">ROOT</span>/</span><br><span class="line"> ---&gt; <span class="title class_">Using</span> cache</span><br><span class="line"> ---&gt; <span class="number">9350</span>deb03d0d</span><br><span class="line"><span class="title class_">Step</span> <span class="number">3</span>/<span class="number">6</span> : <span class="title class_">RUN</span> rm -fr *</span><br><span class="line"> ---&gt; <span class="title class_">Using</span> cache</span><br><span class="line"> ---&gt; f6814fab3fe4</span><br><span class="line"><span class="title class_">Step</span> <span class="number">4</span>/<span class="number">6</span> : <span class="title class_">COPY</span> project.tar .</span><br><span class="line"> ---&gt; <span class="number">2</span>b0dfa7fb134</span><br><span class="line"><span class="title class_">Step</span> <span class="number">5</span>/<span class="number">6</span> : <span class="title class_">RUN</span> tar -xf project.tar</span><br><span class="line"> ---&gt; <span class="title class_">Running</span> <span class="keyword">in</span> <span class="number">48</span>de494adfe6</span><br><span class="line"><span class="title class_">Removing</span> intermediate container <span class="number">48</span>de494adfe6</span><br><span class="line"> ---&gt; <span class="number">4</span>ae473e72609</span><br><span class="line"><span class="title class_">Step</span> <span class="number">6</span>/<span class="number">6</span> : <span class="title class_">RUN</span> rm project.tar</span><br><span class="line"> ---&gt; <span class="title class_">Running</span> <span class="keyword">in</span> cb057261565c</span><br><span class="line"><span class="title class_">Removing</span> intermediate container cb057261565c</span><br><span class="line"> ---&gt; <span class="number">98</span>cdee09487c</span><br><span class="line"><span class="title class_">Successfully</span> built <span class="number">98</span>cdee09487c</span><br><span class="line"><span class="title class_">Successfully</span> tagged <span class="symbol">myproject:</span>latest</span><br><span class="line">[root<span class="variable">@MyCentOS</span>]/usr/local/docker/tomcat<span class="comment"># docker run -it --rm myproject bash</span></span><br><span class="line">root<span class="variable">@fff6dea62b52</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># ls</span></span><br><span class="line">index.html</span><br><span class="line">root<span class="variable">@fff6dea62b52</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># vi</span></span><br><span class="line"><span class="symbol">bash:</span> <span class="symbol">vi:</span> command <span class="keyword">not</span> found</span><br><span class="line">root<span class="variable">@fff6dea62b52</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># vi index.html</span></span><br><span class="line"><span class="symbol">bash:</span> <span class="symbol">vi:</span> command <span class="keyword">not</span> found</span><br><span class="line">root<span class="variable">@fff6dea62b52</span><span class="symbol">:/usr/local/tomcat/webapps/ROOT</span><span class="comment"># cat index.html</span></span><br><span class="line">&lt;!<span class="title class_">DOCTYPE</span> html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;<span class="title class_">Docker</span>文件测试&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;h1&gt;<span class="title class_">Hello</span> <span class="title class_">Docker</span>&lt;/h1&gt;</span><br><span class="line">	&lt;h2&gt;我是压缩后的文件&lt;/h2&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>查看结果:</p>
<p><img src="/2019/09/23/Docker%E5%AD%A6%E4%B9%A06-Dockerfile%E5%AE%9A%E5%88%B6%E9%95%9C%E5%83%8F4-Dockerfile%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/2.png" alt></p>
<h2><span id="指令列表">指令列表</span></h2>
<ul>
<li>COPY</li>
<li>ADD</li>
<li>CMD</li>
<li>ENTRYPOINT</li>
<li>ENV</li>
<li>VOLUME</li>
<li>EXPOSE</li>
<li>WORKDIR</li>
</ul>
<h2><span id="copy">COPY</span></h2>
<p>格式：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> &lt;源路径&gt;... &lt;目标路径&gt;</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> [<span class="string">&quot;&lt;源路径1&gt;&quot;</span>,... <span class="string">&quot;&lt;目标路径&gt;&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>和 RUN 指令一样，也有两种格式，一种类似于命令行，一种类似于函数调用。</p>
<p>COPY 指令将从构建上下文目录中 &lt;源路径&gt; 的文件 / 目录复制到新的一层的镜像内的 &lt;目标路径&gt; 位置。比如：</p>
<p>COPY package.json /usr/src/app/<br>
&lt;源路径&gt; 可以是多个，甚至可以是通配符，其通配符规则要满足 Go 的 filepath.Match 规则，如：</p>
<p>COPY hom* /mydir/<br>
COPY hom?.txt /mydir/<br>
&lt;目标路径&gt; 可以是容器内的绝对路径，也可以是相对于工作目录的相对路径（工作目录可以用 WORKDIR 指令来指定）。目标路径不需要事先创建，如果目录不存在会在复制文件前先行创建缺失目录。</p>
<p>此外，还需要注意一点，使用 COPY 指令，源文件的各种元数据都会保留。比如读、写、执行权限、文件变更时间等。这个特性对于镜像定制很有用。特别是构建相关文件都在使用 Git 进行管理的时候。</p>
<h2><span id="add">ADD</span></h2>
<p>ADD 指令和 COPY 的格式和性质基本一致。但是在 COPY 基础上增加了一些功能。</p>
<p>比如 &lt;源路径&gt; 可以是一个 URL，这种情况下，Docker 引擎会试图去下载这个链接的文件放到 &lt;目标路径&gt; 去。下载后的文件权限自动设置为 600，如果这并不是想要的权限，那么还需要增加额外的一层 RUN 进行权限调整，另外，如果下载的是个压缩包，需要解压缩，也一样还需要额外的一层 RUN 指令进行解压缩。所以不如直接使用 RUN 指令，然后使用 wget 或者 curl 工具下载，处理权限、解压缩、然后清理无用文件更合理。因此，这个功能其实并不实用，而且不推荐使用。</p>
<p>如果 &lt;源路径&gt; 为一个 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，ADD 指令将会自动解压缩这个压缩文件到 &lt;目标路径&gt; 去。</p>
<p>在某些情况下，这个自动解压缩的功能非常有用，比如官方镜像 ubuntu 中：</p>
<p>FROM scratch<br>
ADD ubuntu-xenial-core-cloudimg-amd64-root.tar.gz /<br>
…<br>
但在某些情况下，如果我们真的是希望复制个压缩文件进去，而不解压缩，这时就不可以使用 ADD 命令了。</p>
<p>在 Docker 官方的 Dockerfile 最佳实践文档 中要求，尽可能的使用 COPY，因为 COPY 的语义很明确，就是复制文件而已，而 ADD 则包含了更复杂的功能，其行为也不一定很清晰。最适合使用 ADD 的场合，就是所提及的需要自动解压缩的场合。</p>
<p>另外需要注意的是，ADD 指令会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。</p>
<p>因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD。</p>
<h2><span id="cmd">CMD</span></h2>
<p>CMD 指令的格式和 RUN 相似，也是两种格式：</p>
<p>shell 格式：CMD &lt;命令&gt;<br>
exec 格式：CMD [“可执行文件”, “参数1”, “参数2”…]<br>
参数列表格式：CMD [“参数1”, “参数2”…]。在指定了 ENTRYPOINT 指令后，用 CMD 指定具体的参数。<br>
之前介绍容器的时候曾经说过，Docker 不是虚拟机，容器就是进程。既然是进程，那么在启动容器的时候，需要指定所运行的程序及参数。CMD 指令就是用于指定默认的容器主进程的启动命令的。</p>
<p>在运行时可以指定新的命令来替代镜像设置中的这个默认命令，比如，ubuntu 镜像默认的 CMD 是 /bin/bash，如果我们直接 docker run -it ubuntu 的话，会直接进入 bash。我们也可以在运行时指定运行别的命令，如 docker run -it ubuntu cat /etc/os-release。这就是用 cat /etc/os-release 命令替换了默认的 /bin/bash 命令了，输出了系统版本信息。</p>
<p>在指令格式上，一般推荐使用 exec 格式，这类格式在解析时会被解析为 JSON 数组，因此一定要使用双引号 &quot;，而不要使用单引号。</p>
<p>如果使用 shell 格式的话，实际的命令会被包装为 sh -c 的参数的形式进行执行。比如：</p>
<p>CMD echo $HOME<br>
在实际执行中，会将其变更为：</p>
<p>CMD [ “sh”, “-c”, “echo $HOME” ]<br>
这就是为什么我们可以使用环境变量的原因，因为这些环境变量会被 shell 进行解析处理。</p>
<p>提到 CMD 就不得不提容器中应用在前台执行和后台执行的问题。这是初学者常出现的一个混淆。</p>
<p>Docker 不是虚拟机，容器中的应用都应该以前台执行，而不是像虚拟机、物理机里面那样，用 upstart/systemd 去启动后台服务，容器内没有后台服务的概念。</p>
<p>一些初学者将 CMD 写为：</p>
<p>CMD service nginx start<br>
然后发现容器执行后就立即退出了。甚至在容器内去使用 systemctl 命令结果却发现根本执行不了。这就是因为没有搞明白前台、后台的概念，没有区分容器和虚拟机的差异，依旧在以传统虚拟机的角度去理解容器。</p>
<p>对于容器而言，其启动程序就是容器应用进程，容器就是为了主进程而存在的，主进程退出，容器就失去了存在的意义，从而退出，其它辅助进程不是它需要关心的东西。</p>
<p>而使用 service nginx start 命令，则是希望 upstart 来以后台守护进程形式启动 nginx 服务。而刚才说了 CMD service nginx start 会被理解为 CMD [ “sh”, “-c”, “service nginx start”]，因此主进程实际上是 sh。那么当 service nginx start 命令结束后，sh 也就结束了，sh 作为主进程退出了，自然就会令容器退出。</p>
<p>正确的做法是直接执行 nginx 可执行文件，并且要求以前台形式运行。比如：</p>
<p>CMD [“nginx”, “-g”, “daemon off;”]</p>
<h2><span id="entrypoint">ENTRYPOINT</span></h2>
<p>ENTRYPOINT 的格式和 RUN 指令格式一样，分为 exec 格式和 shell 格式。</p>
<p>ENTRYPOINT 的目的和 CMD 一样，都是在指定容器启动程序及参数。ENTRYPOINT 在运行时也可以替代，不过比 CMD 要略显繁琐，需要通过 docker run 的参数 --entrypoint 来指定。</p>
<p>当指定了 ENTRYPOINT 后，CMD 的含义就发生了改变，不再是直接的运行其命令，而是将 CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为：</p>
<p><entrypoint> &quot;<cmd>&quot;<br>
那么有了 CMD 后，为什么还要有 ENTRYPOINT 呢？这种 <entrypoint> “<cmd>” 有什么好处么？让我们来看几个场景。</cmd></entrypoint></cmd></entrypoint></p>
<h2><span id="场景一让镜像变成像命令一样使用">场景一：让镜像变成像命令一样使用</span></h2>
<p>假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 CMD 来实现：</p>
<p>FROM ubuntu:16.04<br>
RUN apt-get update <br>
&amp;&amp; apt-get install -y curl <br>
&amp;&amp; rm -rf /var/lib/apt/lists/*<br>
CMD [ “curl”, “-s”, “<a target="_blank" rel="noopener" href="http://ip.cn">http://ip.cn</a>” ]<br>
假如我们使用 docker build -t myip . 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p>
<p>$ docker run myip<br>
当前 IP：61.148.226.66 来自：北京市 联通<br>
嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 CMD 中可以看到实质的命令是 curl，那么如果我们希望显示 HTTP 头信息，就需要加上 -i 参数。那么我们可以直接加 -i 参数给 docker run myip 么？</p>
<p>$ docker run myip -i<br>
docker: Error response from daemon: invalid header field value “oci runtime error: container_linux.go:247: starting container process caused “exec: \”-i\”: executable file not found in $PATH&quot;\n&quot;.<br>
我们可以看到可执行文件找不到的报错，executable file not found。之前我们说过，跟在镜像名后面的是 command，运行时会替换 CMD 的默认值。因此这里的 -i 替换了原来的 CMD，而不是添加在原来的 curl -s <a target="_blank" rel="noopener" href="http://ip.cn">http://ip.cn</a> 后面。而 -i 根本不是命令，所以自然找不到。</p>
<p>那么如果我们希望加入 -i 这参数，我们就必须重新完整的输入这个命令：</p>
<p>$ docker run myip curl -s <a target="_blank" rel="noopener" href="http://ip.cn">http://ip.cn</a> -i<br>
这显然不是很好的解决方案，而使用 ENTRYPOINT 就可以解决这个问题。现在我们重新用 ENTRYPOINT 来实现这个镜像：</p>
<p>FROM ubuntu:16.04<br>
RUN apt-get update <br>
&amp;&amp; apt-get install -y curl <br>
&amp;&amp; rm -rf /var/lib/apt/lists/*<br>
ENTRYPOINT [ “curl”, “-s”, “<a target="_blank" rel="noopener" href="http://ip.cn">http://ip.cn</a>” ]<br>
这次我们再来尝试直接使用 docker run myip -i：</p>
<p>$ docker run myip<br>
当前 IP：61.148.226.66 来自：北京市 联通</p>
<p>$ docker run myip -i<br>
HTTP/1.1 200 OK<br>
Server: nginx/1.8.0<br>
Date: Tue, 22 Nov 2016 05:12:40 GMT<br>
Content-Type: text/html; charset=UTF-8<br>
Vary: Accept-Encoding<br>
X-Powered-By: PHP/5.6.24-1~dotdeb+7.1<br>
X-Cache: MISS from cache-2<br>
X-Cache-Lookup: MISS from cache-2:80<br>
X-Cache: MISS from proxy-2_6<br>
Transfer-Encoding: chunked<br>
Via: 1.1 cache-2:80, 1.1 proxy-2_6:8006<br>
Connection: keep-alive</p>
<p>当前 IP：61.148.226.66 来自：北京市 联通<br>
可以看到，这次成功了。这是因为当存在 ENTRYPOINT 后，CMD 的内容将会作为参数传给 ENTRYPOINT，而这里 -i 就是新的 CMD，因此会作为参数传给 curl，从而达到了我们预期的效果。</p>
<h2><span id="场景二应用运行前的准备工作">场景二：应用运行前的准备工作</span></h2>
<p>启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。</p>
<p>比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p>
<p>此外，可能希望避免使用 root 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 root 身份执行，方便调试等。</p>
<p>这些准备工作是和容器 CMD 无关的，无论 CMD 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 ENTRYPOINT 中去执行，而这个脚本会将接到的参数（也就是 <cmd>）作为命令，在脚本最后执行。比如官方镜像 redis 中就是这么做的：</cmd></p>
<p>FROM alpine:3.4<br>
…<br>
RUN addgroup -S redis &amp;&amp; adduser -S -G redis redis<br>
…<br>
ENTRYPOINT [“<a target="_blank" rel="noopener" href="http://docker-entrypoint.sh">docker-entrypoint.sh</a>”]</p>
<p>EXPOSE 6379<br>
CMD [ “redis-server” ]<br>
可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 ENTRYPOINT 为 <a target="_blank" rel="noopener" href="http://docker-entrypoint.sh">docker-entrypoint.sh</a> 脚本。</p>
<h2><span id="binsh">!/bin/sh</span></h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> = <span class="string">&#x27;redis-server&#x27;</span> -a <span class="string">&quot;<span class="subst">$(id -u)</span>&quot;</span> = <span class="string">&#x27;0&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">chown</span> -R redis .</span><br><span class="line">	<span class="built_in">exec</span> su-exec redis <span class="string">&quot;<span class="variable">$0</span>&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>该脚本的内容就是根据 CMD 的内容来判断，如果是 redis-server 的话，则切换到 redis 用户身份启动服务器，否则依旧使用 root 身份执行。比如：</p>
<p>$ docker run -it redis id<br>
uid=0(root) gid=0(root) groups=0(root)</p>
<h2><span id="env">ENV</span></h2>
<p>格式有两种：</p>
<p>ENV <key> <value><br>
ENV <key1>=<value1> <key2>=<value2>…<br>
这个指令很简单，就是设置环境变量而已，无论是后面的其它指令，如 RUN，还是运行时的应用，都可以直接使用这里定义的环境变量。</value2></key2></value1></key1></value></key></p>
<p>ENV VERSION=1.0 DEBUG=on <br>
NAME=&quot;Happy Feet&quot;<br>
这个例子中演示了如何换行，以及对含有空格的值用双引号括起来的办法，这和 Shell 下的行为是一致的。</p>
<p>定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。比如在官方 node 镜像 Dockerfile 中，就有类似这样的代码：</p>
<p>ENV NODE_VERSION 7.2.0</p>
<p>RUN curl -SLO “<a target="_blank" rel="noopener" href="https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz">https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz</a>” <br>
&amp;&amp; curl -SLO “<a target="_blank" rel="noopener" href="https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc">https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc</a>” <br>
&amp;&amp; gpg --batch --decrypt --output SHASUMS256.txt SHASUMS256.txt.asc <br>
&amp;&amp; grep &quot; node-v$NODE_VERSION-linux-x64.tar.xz$&quot; SHASUMS256.txt | sha256sum -c - <br>
&amp;&amp; tar -xJf “node-v$NODE_VERSION-linux-x64.tar.xz” -C /usr/local --strip-components=1 <br>
&amp;&amp; rm “node-v$NODE_VERSION-linux-x64.tar.xz” SHASUMS256.txt.asc SHASUMS256.txt <br>
&amp;&amp; ln -s /usr/local/bin/node /usr/local/bin/nodejs<br>
在这里先定义了环境变量 NODE_VERSION，其后的 RUN 这层里，多次使用 $NODE_VERSION 来进行操作定制。可以看到，将来升级镜像构建版本的时候，只需要更新 7.2.0 即可，Dockerfile 构建维护变得更轻松了。</p>
<p>下列指令可以支持环境变量展开： ADD、COPY、ENV、EXPOSE、LABEL、USER、WORKDIR、VOLUME、STOPSIGNAL、ONBUILD。</p>
<p>可以从这个指令列表里感觉到，环境变量可以使用的地方很多，很强大。通过环境变量，我们可以让一份 Dockerfile 制作更多的镜像，只需使用不同的环境变量即可。</p>
<h2><span id="volume">VOLUME</span></h2>
<p>格式为：</p>
<p>VOLUME [&quot;&lt;路径1&gt;&quot;, “&lt;路径2&gt;”…]<br>
VOLUME &lt;路径&gt;<br>
之前我们说过，容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷 (volume) 中，后面的章节我们会进一步介绍 Docker 卷的概念。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 Dockerfile 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p>
<p>VOLUME /data<br>
这里的 /data 目录就会在运行时自动挂载为匿名卷，任何向 /data 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行时可以覆盖这个挂载设置。比如：</p>
<p>docker run -d -v mydata:/data xxxx<br>
在这行命令中，就使用了 mydata 这个命名卷挂载到了 /data 这个位置，替代了 Dockerfile 中定义的匿名卷的挂载配置。</p>
<h2><span id="expose">EXPOSE</span></h2>
<p>格式为 EXPOSE &lt;端口1&gt; [&lt;端口2&gt;…]。</p>
<p>EXPOSE 指令是声明运行时容器提供服务端口，这只是一个声明，在运行时并不会因为这个声明应用就会开启这个端口的服务。在 Dockerfile 中写入这样的声明有两个好处，一个是帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射；另一个用处则是在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</p>
<p>此外，在早期 Docker 版本中还有一个特殊的用处。以前所有容器都运行于默认桥接网络中，因此所有容器互相之间都可以直接访问，这样存在一定的安全性问题。于是有了一个 Docker 引擎参数 --icc=false，当指定该参数后，容器间将默认无法互访，除非互相间使用了 --links 参数的容器才可以互通，并且只有镜像中 EXPOSE 所声明的端口才可以被访问。这个 --icc=false 的用法，在引入了 docker network 后已经基本不用了，通过自定义网络可以很轻松的实现容器间的互联与隔离。</p>
<p>要将 EXPOSE 和在运行时使用 -p &lt;宿主端口&gt;:&lt;容器端口&gt; 区分开来。-p，是映射宿主端口和容器端口，换句话说，就是将容器的对应端口服务公开给外界访问，而 EXPOSE 仅仅是声明容器打算使用什么端口而已，并不会自动在宿主进行端口映射。</p>
<h2><span id="workdir">WORKDIR</span></h2>
<p>格式为 WORKDIR &lt;工作目录路径&gt;。</p>
<p>使用 WORKDIR 指令可以来指定工作目录（或者称为当前目录），以后各层的当前目录就被改为指定的目录，如该目录不存在，WORKDIR 会帮你建立目录。</p>
<p>之前提到一些初学者常犯的错误是把 Dockerfile 等同于 Shell 脚本来书写，这种错误的理解还可能会导致出现下面这样的错误：</p>
<p>RUN cd /app<br>
RUN echo “hello” &gt; world.txt<br>
如果将这个 Dockerfile 进行构建镜像运行后，会发现找不到 /app/world.txt 文件，或者其内容不是 hello。原因其实很简单，在 Shell 中，连续两行是同一个进程执行环境，因此前一个命令修改的内存状态，会直接影响后一个命令；而在 Dockerfile 中，这两行 RUN 命令的执行环境根本不同，是两个完全不同的容器。这就是对 Dockerfile 构建分层存储的概念不了解所导致的错误。</p>
<p>之前说过每一个 RUN 都是启动一个容器、执行命令、然后提交存储层文件变更。第一层 RUN cd /app 的执行仅仅是当前进程的工作目录变更，一个内存上的变化而已，其结果不会造成任何文件变更。而到第二层的时候，启动的是一个全新的容器，跟第一层的容器更完全没关系，自然不可能继承前一层构建过程中的内存变化。</p>
<p>因此如果需要改变以后各层的工作目录的位置，那么应该使用 WORKDIR 指令。</p>
<h2><span id="参考文档">参考文档</span></h2>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/av29384041/?p=37">https://www.bilibili.com/video/av29384041/?p=37</a><br>
<a target="_blank" rel="noopener" href="https://www.funtl.com/zh/docker/Docker-%E6%93%8D%E4%BD%9C-Docker-%E5%AE%B9%E5%99%A8.html">https://www.funtl.com/zh/docker/Docker-操作-Docker-容器.html</a></p>
</blockquote>


                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/09/23/Docker学习7-Docker容器/" data-toggle="tooltip" data-placement="top" title="Docker学习7-Docker容器">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/09/23/并发的原子性-可见性-有序性/" data-toggle="tooltip" data-placement="top" title="并发的原子性,可见性,有序性">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>

            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Dockerfile指令详解</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">练习过程</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link"><span class="toc-nav-number">1.1.1.</span> <span class="toc-nav-text">使用Dockerfile将压缩包导入镜像</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link"><span class="toc-nav-number">1.1.2.</span> <span class="toc-nav-text">使用Dockerfile指令,解压打包的tar包并且删除tar包</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">指令列表</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">COPY</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">ADD</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">CMD</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">ENTRYPOINT</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.7.</span> <span class="toc-nav-text">场景一：让镜像变成像命令一样使用</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.8.</span> <span class="toc-nav-text">场景二：应用运行前的准备工作</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.9.</span> <span class="toc-nav-text">!&#x2F;bin&#x2F;sh</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.10.</span> <span class="toc-nav-text">ENV</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.11.</span> <span class="toc-nav-text">VOLUME</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.12.</span> <span class="toc-nav-text">EXPOSE</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.13.</span> <span class="toc-nav-text">WORKDIR</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link"><span class="toc-nav-number">1.14.</span> <span class="toc-nav-text">参考文档</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    


            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Docker" title="Docker">Docker</a>
                        
                          <a class="tag" href="/tags/#Dockerfile" title="Dockerfile">Dockerfile</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.douban.com/people/80901919/" target="_blank">豆瓣 十渊</a></li>
                    
                        <li><a href="https://github.com/niziming" target="_blank">GitHub niziming</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("/js/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com//localhost/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 十渊 2025
                    <br>
                    Theme by <a target="_blank" rel="noopener" href="http://huangxuan.me">Hux</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    re-Ported by <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a> |
                    <!--<iframe-->
                        <!--style="margin-left: 2px; margin-bottom:-5px;"-->
                        <!--frameborder="0" scrolling="0" width="91px" height="20px"-->
                        <!--src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true" >-->
                    <!--</iframe>-->
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=niziming&amp;repo=hexo-blog&amp;type=star&amp;count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document,
          t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("/js/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'https://niziming.github.io/';
    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script', '/js/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
